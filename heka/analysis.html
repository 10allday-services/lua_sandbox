
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Analysis Interface Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-navigator/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="output.html" />
    
    
    <link rel="prev" href="input.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Lua Sandbox Library (1.4.0)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../sandbox.html">
            
                <a href="../sandbox.html">
            
                    
                    Generic Sandbox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Heka Sandbox
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="input.html">
            
                <a href="input.html">
            
                    
                    Input Interface
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2" data-path="analysis.html">
            
                <a href="analysis.html">
            
                    
                    Analysis Interface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="output.html">
            
                <a href="output.html">
            
                    
                    Output Interface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="message.html">
            
                <a href="message.html">
            
                    
                    Message Schema
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../util/message_matcher.html">
            
                <a href="../util/message_matcher.html">
            
                    
                    Message Matcher
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../cli/">
            
                <a href="../cli/">
            
                    
                    Command Line Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <a target="_blank" href="https://mozilla-services.github.io/lua_sandbox/doxygen/index.html">
            
                    
                    Source Documentation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <a target="_blank" href="https://mozilla-services.github.io/lua_sandbox_extensions">
            
                    
                    Sandbox Extensions
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Analysis Interface</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="Analysis_Sandbox_Interface">Analysis Sandbox Interface</h1>
<h2 id="Recommendations">1. Recommendations</h2>
<p>Since the sandbox does not run in isolation there are some expectations of how
the host infrastructure behaves.  The current recommendations are based on the
Hindsight reference implementation.</p>
<h2 id="Disabled_Functionality">2. Disabled Functionality</h2>
<ul>
<li><a href="http://www.lua.org/manual/5.1/manual.html#5.1" target="_blank">base library</a><ul>
<li>collectgarbage, dofile, load, loadfile, loadstring, newproxy</li>
</ul>
</li>
<li><a href="http://www.lua.org/manual/5.1/manual.html#5.2" target="_blank">coroutine</a><ul>
<li>the entire module is inaccessible</li>
</ul>
</li>
<li><a href="http://www.lua.org/manual/5.1/manual.html#5.4" target="_blank">string</a><ul>
<li>dump</li>
</ul>
</li>
<li><a href="http://www.lua.org/manual/5.1/manual.html#5.7" target="_blank">io</a><ul>
<li>the entire module is inaccessible</li>
</ul>
</li>
<li><a href="http://www.lua.org/manual/5.1/manual.html#5.8" target="_blank">os</a><ul>
<li>getenv, execute, exit, remove, rename, setlocale, tmpname</li>
</ul>
</li>
</ul>
<h2 id="Required_Lua_Functions_(called_by_the_host)">3. Required Lua Functions (called by the host)</h2>
<h3 id="process_message">3.1. process_message</h3>
<p>Called when the host has a message available for analysis.  Usually used in
combination with a <a href="../util/message_matcher.html">message matcher</a> expression.</p>
<p>Recommenation: specify this as a <code>message_matcher</code> configuration option.</p>
<p><em>Arguments</em></p>
<ul>
<li>none</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>status_code (number)<ul>
<li>success (less than or equal to zero)</li>
<li>fatal error (greater than zero)</li>
</ul>
</li>
<li>status_message (optional: string) logged when the status code is less than
zero</li>
</ul>
<h3 id="timer_event">3.2. timer_event</h3>
<p>Called when the host timer expires or on shutdown.</p>
<p>Recommendation: specify this as a <code>ticker_interval</code> configuration option.</p>
<p><em>Arguments</em></p>
<ul>
<li>ns (number) - nanosecond timestamp of the function call (it is actually
<code>time_t * 1e9</code> to keep the timestamp units consistent so it will only have a
one second resolution)</li>
<li>shutdown (bool) - true if timer_event is being called due to a shutdown</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>none</li>
</ul>
<h2 id="Available_C_Functions_(called_from_the_plugin)">4. Available C Functions (called from the plugin)</h2>
<h3 id="read_config">4.1. read_config</h3>
<p>Provides access to the sandbox configuration variables.</p>
<p><em>Arguments</em></p>
<ul>
<li>key (string) - configuration key name</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>value (string, number, bool, table)</li>
</ul>
<h3 id="read_message">4.2. read_message</h3>
<p>Provides access to the Heka message data. Note that both fieldIndex and
arrayIndex are zero-based (i.e. the first element is 0) as opposed to Lua&apos;s
standard indexing, which is one-based.</p>
<p><em>Arguments</em></p>
<ul>
<li>variableName (string)<ul>
<li>framed (returns the Heka message protobuf string including the framing
header)</li>
<li>raw (returns the Heka message protobuf string)</li>
<li>size (returns the size of the raw Heka message protobuf string)</li>
<li>Uuid</li>
<li>Type</li>
<li>Logger</li>
<li>Payload</li>
<li>EnvVersion</li>
<li>Hostname</li>
<li>Timestamp</li>
<li>Severity</li>
<li>Pid</li>
<li>Fields[<em>name</em>]</li>
</ul>
</li>
<li>fieldIndex (unsigned) - only used in combination with the Fields variableName
use to retrieve a specific instance of a repeated field <em>name</em>; zero indexed</li>
<li>arrayIndex (unsigned) - only used in combination with the Fields variableName
use to retrieve a specific element out of a field containing an array; zero
indexed</li>
<li>zeroCopy (bool, optional default false) - returns a userdata place holder for
the message variable (only valid for string types). Non string headers throw an
error during construction, non string fields throw an error on data retrieval.</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>value (number, string, bool, nil, userdata depending on the type of variable
requested)</li>
</ul>
<h3 id="decode_message">4.3. decode_message</h3>
<p>Converts a Heka protobuf encoded message string into a Lua table or throws an
error.</p>
<p><em>Arguments</em></p>
<ul>
<li>heka_pb (string, userdata) - Heka protobuf binary string or a zero copy
userdata object containing a Heka protobuf binary string.</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>msg (<a href="message.html#array-based-message-fields">Heka message table (array fields)</a>)
with the value member always being an array (even if there is only a
single item). This format makes working with the output more consistent. The
wide variation in the inject table formats is to ease the construction of the
message especially when using an LPeg grammar transformation.</li>
</ul>
<h3 id="inject_message">4.4. inject_message</h3>
<p>Creates a new Heka protocol buffer message using the contents of the specified
Lua table (overwriting whatever is in the payload buffer). <code>Timestamp</code>,
<code>Logger</code>, <code>Hostname</code> and <code>Pid</code> are restricted header values. An override
configuration option is provided <code>restricted_headers</code>; when true (default) the
headers are always set to the configuration values; when false the headers are
set to the values provided in the message table, if no value is provided it
defaults to the appropriate value.</p>
<p><em>Arguments</em></p>
<ul>
<li>msg (<a href="message.html">Heka message table</a>)</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>none (throws an error if the table does not match the Heka message schema)</li>
</ul>
<h3 id="add_to_payload">4.5. add_to_payload</h3>
<p>Appends the arguments to the payload buffer for incremental construction of the
final payload output (<code>inject_payload</code> finalizes the buffer and sends the
message to the infrastructure). This function is a rename of the generic sandbox
output function to improve the readability of the plugin code.</p>
<p><em>Arguments</em></p>
<ul>
<li>arg (number, string, bool, nil, supported userdata)</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>none (throws an error if arg is an unsupported type)</li>
</ul>
<h3 id="inject_payload">4.6. inject_payload</h3>
<p>This is a wrapper function for <code>inject_message</code> that is included for backwards
compatibility. The function creates a new Heka message using the contents of the
payload buffer (pre-populated with <code>add_to_payload</code>) and combined with any
additional payload_args passed here. The payload buffer is cleared after the
injection. The <code>payload_type</code> and <code>payload_name</code> arguments are two pieces of
optional metadata stored is message fields. The resulting message is structured
like this:</p>
<pre><code class="lang-lua">msg = {
Timestamp   = &lt;current time&gt;
Uuid        = <span class="hljs-string">&quot;&lt;auto generated&gt;&quot;</span>
Hostname    = <span class="hljs-string">&quot;&lt;the Hostname from the config&gt;&quot;</span>
Logger      = <span class="hljs-string">&quot;&lt;the Logger name from the config&gt;&quot;</span>
Type        = <span class="hljs-string">&quot;inject_payload&quot;</span>
Payload     = <span class="hljs-string">&quot;&lt;payload buffer contents&gt;&quot;</span>
Fields      = {
    payload_type = <span class="hljs-string">&quot;txt&quot;</span>,
    payload_name = <span class="hljs-string">&quot;&quot;</span>,
}
</code></pre>
<p><em>Arguments</em></p>
<ul>
<li>payload_type (optional: string, default &quot;txt&quot;) - describes the content type of
the injected payload data</li>
<li>payload_name (optional: string,  default &quot;&quot;) - names the content to aid in
downstream filtering</li>
<li>arg3 (optional) -ame type restrictions as <code>add_to_payload</code></li>
<li>...</li>
<li>argN</li>
</ul>
<p><em>Return</em></p>
<ul>
<li>none (throws an error if arg is an unsupported type)</li>
</ul>
<h3 id="Modes_of_Operation">4.7. Modes of Operation</h3>
<h4 id="Lock_Step">4.7.1. Lock Step</h4>
<ul>
<li>Receives one call to <code>process_message</code>, operates on the message, and returns
success (0) or failure (-1)</li>
</ul>
<h4 id="Example_simple_counter_plugin">4.7.2. Example simple counter plugin</h4>
<pre><code class="lang-lua"><span class="hljs-comment">-- cfg</span>
message_matcher = <span class="hljs-string">&quot;TRUE&quot;</span>
ticker_interval = <span class="hljs-number">5</span>
</code></pre>
<pre><code class="lang-lua"><span class="hljs-comment">-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<span class="hljs-comment">-- License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<span class="hljs-comment">-- file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>

<span class="hljs-keyword">local</span> cnt = <span class="hljs-number">0</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process_message</span><span class="hljs-params">()</span></span>
    cnt = cnt + <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">timer_event</span><span class="hljs-params">()</span></span>
    inject_payload(<span class="hljs-string">&quot;txt&quot;</span>, <span class="hljs-string">&quot;count&quot;</span>, cnt)
<span class="hljs-keyword">end</span>
</code></pre>
<div id="anchors-navbar"><i class="fa fa-anchor"></i><ul><p><a href="#Analysis_Sandbox_Interface">Analysis Sandbox Interface</a></p><li><a href="#Recommendations">1. Recommendations</a></li><li><a href="#Disabled_Functionality">2. Disabled Functionality</a></li><li><a href="#Required_Lua_Functions_(called_by_the_host)">3. Required Lua Functions (called by the host)</a></li><ul><li><a href="#process_message">3.1. process_message</a></li><li><a href="#timer_event">3.2. timer_event</a></li></ul><li><a href="#Available_C_Functions_(called_from_the_plugin)">4. Available C Functions (called from the plugin)</a></li><ul><li><a href="#read_config">4.1. read_config</a></li><li><a href="#read_message">4.2. read_message</a></li><li><a href="#decode_message">4.3. decode_message</a></li><li><a href="#inject_message">4.4. inject_message</a></li><li><a href="#add_to_payload">4.5. add_to_payload</a></li><li><a href="#inject_payload">4.6. inject_payload</a></li><li><a href="#Modes_of_Operation">4.7. Modes of Operation</a></li><ul><li><a href="#Lock_Step">4.7.1. Lock Step</a></li><li><a href="#Example_simple_counter_plugin">4.7.2. Example simple counter plugin</a></li></ul></ul></ul></div><a href="#Recommendations" id="goTop"><i class="fa fa-arrow-up"></i></a>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="input.html" class="navigation navigation-prev " aria-label="Previous page: Input Interface">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="output.html" class="navigation navigation-next " aria-label="Next page: Output Interface">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Analysis Interface","level":"1.3.2","depth":2,"next":{"title":"Output Interface","level":"1.3.3","depth":2,"path":"heka/output.md","ref":"heka/output.md","articles":[]},"previous":{"title":"Input Interface","level":"1.3.1","depth":2,"path":"heka/input.md","ref":"heka/input.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["collapsible-menu","navigator"],"pluginsConfig":{"collapsible-menu":{},"navigator":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"heka/analysis.md","mtime":"2018-06-27T21:50:52.526Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2020-07-02T21:19:36.257Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

